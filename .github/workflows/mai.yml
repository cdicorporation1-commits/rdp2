name: RustDesk Portable en Windows

on:
  workflow_dispatch:
    inputs:
      rustdesk_id:
        type: string
        required: false
      rustdesk_password:
        type: string
        required: false

jobs:
  desktop:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Descargar
        run: |
          curl -L https://github.com/rustdesk/rustdesk/releases/download/1.2.4/rustdesk-1.2.4-x86_64.exe -o rustdesk.exe

      - name: Ejecutar (con desbloqueo)
        id: run
        shell: pwsh
        run: |
          $id = "${{ github.event.inputs.rustdesk_id }}"
          $pw = "${{ github.event.inputs.rustdesk_password }}"
          if (!$id) { $id = "GH$(Get-Date -Format 'HHmmss')" }
          if (!$pw) { $pw = "Pass$(Get-Random -Minimum 10000 -Maximum 99999)!" }

          $configDir = "$PWD\rustdesk.exe.config"
          $null = New-Item -ItemType Directory -Path $configDir -Force
          Set-Content "$configDir\RustDesk.toml" "encrypted = false`nid = `"$id`"`npassword = `"$pw`""

          Unblock-File -Path "$PWD\rustdesk.exe"
          Start-Process -FilePath "$PWD\rustdesk.exe" -ArgumentList "--portable" -PassThru
          Start-Sleep 15

          "rustdesk_id=$id" >> $env:GITHUB_OUTPUT
          "rustdesk_password=$pw" >> $env:GITHUB_OUTPUT

      - name: Mostrar credenciales
        run: |
          echo "ID: ${{ steps.run.outputs.rustdesk_id }}"
          echo "Pass: ${{ steps.run.outputs.rustdesk_password }}"
